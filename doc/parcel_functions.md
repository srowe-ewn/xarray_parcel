Module parcel_functions
=======================

Functions
---------

    
`add_lcl_to_profile(profile, vert_dim='model_level_number', temperature=None)`
:   Add the LCL to a profile.
    
    Arguments:
        - profile: Profile as returned from parcel_profile().
        - vert_dim: The vertical dimension to add the LCL pressure/temp to.
        - temperature: Environmental temperatures. If provided, interpolate environment 
                       temperature for the LCL and return as 'env_temperature'.
        
    Returns:
    
        - A new profile object with LCL pressure and temperatures added. Note the 
        vertical coordinate in the new profile is reindexed.

    
`bound_pressure(pressure, bound, vert_dim='model_level_number')`
:   Calculate the bounding pressure in a layer; returns the closest pressure to the bound.
    
    Arguments:
        - pressure: Atmospheric pressures [hPa].
        - bound: Bound to retrieve, broadcastable to pressure [hPa].
    
    Returns:
    
        - The bound pressures.

    
`cape_cin(pressure, temperature, parcel_temperature, parcel_pressure, parcel_dewpoint, moist_adiabat_lookup, moist_adiabats, vert_dim='model_level_number', return_profile=False)`
:   Calculate CAPE and CIN; wraps finding of LFC and parcel profile and call to 
    cape_cin_base. Uses the bottom (highest-pressure) LFC and the top (lowest-pressure) EL.
    
    Arguments:
        - pressure: Pressure level(s) of interest [hPa].
        - temperature: Temperature at each pressure level [K].
        - parcel_temperature: The temperature of the starting parcel [K].
        - parcel_pressure: The pressure of the starting parcel [K].
        - parcel_dewpoint: The dewpoint of the starting parcel [K].
        - moist_adiabat_lookup, moist_adiabats: Adiabat lookup tables generated by 
                                                moist_adiabat_tables().
        - vert_dim: The vertical dimension.
        - return_profile: Also return the lifted profile?
    
    Returns:
    
        - Dataset with convective available potential energy (cape) and 
          convective inhibition (cin), both in J kg-1, plus the lifted profile if 
          return_profile is True.

    
`cape_cin_base(pressure, temperature, lfc_pressure, el_pressure, parcel_profile, vert_dim='model_level_number')`
:   Calculate CAPE and CIN.
    
    Calculate the convective available potential energy (CAPE) and convective inhibition (CIN)
    of a given upper air profile and parcel path. CIN is integrated between the surface and
    LFC, CAPE is integrated between the LFC and EL (or top of sounding). Intersection points
    of the measured temperature profile and parcel profile are logarithmically interpolated.
    
    Uses the bottom (highest-pressure) LFC and the top (lowest-pressure) EL.
    
    Arguments:
        - pressure: Pressure level(s) of interest [hPa].
        - temperature: Temperature at each pressure level [K].
        - lfc_pressure: Pressure of level of free convection [hPa].
        - el_pressure: Pressure of equilibrium level [hPa].
        - parcel_profile: The parcel profile as returned from parcel_profile().
        - vert_dim: The vertical dimension.
    
    Returns:
        - Dataset with convective available potential energy (cape) and 
          convective inhibition (cin), both in J kg-1.

    
`deep_convective_index(pressure, temperature, dewpoint, lifted_index, vert_dim='model_level_number')`
:   Calculate the deep convective index (DCI) as defined by Kunz 2009.
    
    Arguments:
        - pressure: Pressure values [hPa].
        - temperature: Temperature at each pressure [K].
        - dewpoint: Dewpoint temperature at each pressure.
        - lifted_index: The lifted index.
        - vert_dim: The vertical dimension name.
    
    Returns:
    
        - The DCI [C] per point.

    
`dry_lapse(pressure, parcel_temperature, parcel_pressure=None, vert_dim='model_level_number')`
:   Calculate the temperature of a parcel raised dry-adiabatically (conserving
    potential temperature).
    
    Arguments:
        -pressure: Atmospheric pressure level(s) of interest [hPa].
        -parcel_temperature: Parcel temperature before lifting (constant or broadcast-able DataArray).
        - parcel_pressure: Parcel pressure(s) before lifting. Defaults to vertical maximum.
        - vert_dim: The name of the vertical dimension.
    
    Returns:
    
        - Parcel temperature at each pressure level.

    
`find_intersections(x, a, b, dim, log_x=False)`
:   Find intersections of two lines that share x coordinates.
    
    Arguments:
        - x: The shared x coordinate values.
        - a: y values for line 1.
        - b: y values for line 2.
        - dim: The dimension along which the coordinates are indexed.
        - log_x: Use a logarithmic transform on x coordinates (e.g. for pressure coords)?
        
    Returns:
    
        - Dataset containing x, y coordinates for all intersections, 
             increasing intersections and decreasing intersections. Note duplicates 
             are not removed.

    
`get_layer(dat, depth=100, drop=False, vert_dim='model_level_number', interpolate=True)`
:   Return an atmospheric layer from the surface with a given depth.
    
    Arguments:
      - dat: DataArray, must contain pressure.
      - depth: Depth above the bottom of the layer to mix [hPa].
      - drop: Drop unselected elements?
      - vert_dim: Vertical dimension name.
      - interpolate: Interpolate the bottom/top layers?
    
    Returns:
    
      - xarray DataArray with pressure and data variables for the layer.

    
`insert_level(d, level, coords, vert_dim='model_level_number', fill_value=-999)`
:   Insert a new level into a vertically sorted dataset.
    
    Arguments:
        - d: The data to work on.
        - coords: The coordinate name in d.
        - level: The new values to add; a single layer with values for 'coord' 
               and any other variables to add.
        - vert_dim: The vertical dimension to add new level to.
        
    Returns:
    
        - A new object with the new level added.
             Note the vertical coordinate in the new profile is reindexed.

    
`lcl(parcel_pressure, parcel_temperature, parcel_dewpoint)`
:   Return the lifting condensation level for parcels.
    
    Arguments:
        - parcel_pressure: Pressure of the parcel to lift [hPa].
        - parcel_temperature: Parcel temperature [K].
        - parfel_dewpoint: Parcel dewpoint [K].
    
    Returns:
    
        - A Dataset with lcl_pressure and lcl_temperature.

    
`lfc_el(profile, vert_dim='model_level_number')`
:   Calculate the level of free convection (LFC) and equilibrium level (EL). 
    
    Works by finding the first intersection of the ideal parcel path and the measured parcel 
    temperature. If this intersection occurs below the LCL, the LFC is determined to be the 
    same as the LCL, based upon the conditions set forth in [USAF1990]_, pg 4-14, where a 
    parcel must be lifted dry adiabatically to saturation before it can freely rise.
    The LFC returned is the 'bottom' LFC with highest pressure; the EL returned is the 
    'top' EL with the lowest pressure.
    
    Arguments:
        - profile: The parcel profile, including the LCL, as returned from 
                   parcel_profile_with_lcl().
        - vert_dim: Vertical dimension name in input arrays.
    
    Returns:
    
        - DataArray with LFC pressure (lfc_pressure) and temperature (lfc_temperature).

    
`lifted_index(profile, vert_dim='model_level_number')`
:   Calculate the lifted index. 
    
    Lifted index formula derived from Galway 1956 and referenced by DoswellSchultz 2006.
    
    Arguments:
        - profile: Profile as returned by parcel_profile_with_lcl().
        - vert_dim: The vertical dimension name.
    
    Returns:
    
        - Lifted index at each point [K].

    
`linear_interp(x, coords, at, dim='model_level_number')`
:   Perform simple linear interpolation to get values at specified points.
    
    Arguments:
        x: Data set to interpolate.
        coords: Coordinate value for each point in x.
        at: Points at which to interpolate.
        dim: The dimension along which to interpolate.
    
    It is assumed that x[coords] is sorted and does not contain duplicate 
    values along the selected dimension.

    
`log_interp(x, coords, at, dim='model_level_number')`
:   Run linear_interp on logged coordinate values.
    
    Arguments:
        - x: Data set to interpolate.
        - coords: Coordinate value for each point in x.
        - at: Points at which to interpolate.
        - dim: The dimension along which to interpolate.
    
    It is assumed that x[coords] is sorted and does not contain duplicate 
    values along the selected dimension.

    
`mixed_layer(dat, depth=100, vert_dim='model_level_number')`
:   Mix variable(s) over a layer, yielding a mass-weighted average.
    
    Integrate a data variable with respect to pressure and determine the
    average value using the mean value theorem.
    
    Arguments:
        - dat: The DataArray to mix. Must contain pressure and variables.
        - bottom: Pressure above the surface pressure to start from [hPa].
        - depth: Depth above the bottom of the layer to mix [hPa].
        - vert_dim: The name of the vertical dimension.
    
    Returns:
    
        - xarray with mixed values of each data variable.

    
`mixed_layer_cape_cin(pressure, temperature, dewpoint, moist_adiabat_lookup, moist_adiabats, vert_dim='model_level_number', depth=100, return_profile=False)`
:   Calculate CAPE and CIN for a fully-mixed lowest x hPa parcel.
    
    Arguments:
        - pressure: Pressure level(s) of interest [hPa].
        - temperature: Temperature at each pressure level [K].
        - moist_adiabat_lookup, moist_adiabats: Adiabat lookup tables generated by 
                                                moist_adiabat_tables().
        - dewpoint: Dewpoint at each level [K].
        - vert_dim: The vertical dimension.
        - depth: The depth above the surface (lowest-level pressure) to mix [hPa].
        - return_profile: Also return the lifted profile?
        
    Returns:
    
        - Dataset with convective available potential energy (cape) and 
          convective inhibition (cin), both in J kg-1.

    
`mixed_parcel(pressure, temperature, dewpoint, depth=100, vert_dim='model_level_number')`
:   Fully mix a layer of given depth above the surface and find the temparature, 
    pressure and dewpoint of the parcel.
    
    Arguments:
        - pressure: Pressure by level [hPa].
        - temperature: Temperature at each level [K].
        - dewpoint: Dewpoint at each level [K].
        - depth: Depth above the surface to mix [hPa].
        - vert_dim: The name of the vertical dimension.
    
    Returns:
    
        - DataArray with mixed parcel pressure [hPa], temperature [K] and dewpoint [K].

    
`moist_adiabat_lookup(pressure_levels=array([1.1000e+03, 1.0995e+03, 1.0990e+03, ..., 1.5000e+00, 1.0000e+00,
       5.0000e-01]), temperatures=array([173.  , 173.02, 173.04, ..., 315.94, 315.96, 315.98]), pres_step=0.5, temp_step=0.02)`
:   Calculate moist adiabat lookup tables.
    
    Arguments:
        - pressure_levels: Pressure levels to keep in adiabat lookup table [hPa].
        - temperatures: Temperatures to keep in adiabat lookup table [K].
        - pres_step, temp_step: (Positive) step size for pressure_levels and 
                              temperatures, respectively.
                              
    Returns:
        - two DataArrays: 1) a lookup table of pressure/temperature vs. adiabat number, 
             and 2) a lookup table of adiabat number to temperature by pressure profiles.

    
`moist_adiabat_tables(regenerate=False, cache=True, lookup_cache='lookup_tables/moist_adiabat_lookup.nc', adiabats_cache='lookup_tables/adiabats_cache.nc', **kwargs)`
:   Calculate moist adiabat lookup tables.
    
    Arguments:
        - regenerate: Calculate from scratch and save caches?
        - cache: Write cache files?
        - lookup_cache: A cache file (nc) for the adiabat lookup table.
        - adiabats_cache: A cache file (nc) for the adiabats cache.
        - **kwargs: Keyword arguments to moist_adiabat_lookup().
                           
    Returns:
    
        - two DataArrays: 1) a lookup table of pressure/temperature vs. adiabat number, 
             and 2) a lookup table of adiabat number to temperature by pressure profiles.

    
`moist_lapse(pressure, parcel_temperature, moist_adiabat_lookup, moist_adiabats, parcel_pressure=None, vert_dim='model_level_number')`
:   Return the temperature of parcels raised moist-adiabatically (assuming liquid saturation processes).
    Note: What is returned are approximate pseudo-adiabatic moist lapse rates, found using a lookup table.
    
    Arguments:
        - pressure: Atmospheric pressure(s) to lift the parcel to [hPa].
        - parcel_temperature: Temperature(s) of parcels to lift [K].
        - moist_adiabat_lookup, moist_adiabats: Adiabat lookup tables generated by moist_adiabat_tables().
        - parcel_pressure: Parcel pressure before lifting. Defaults to vertical maximum.
        - vert_dim: The name of the vertical dimension.
    
    Returns:
    
        - Parcel temperature at each pressure level.

    
`most_unstable_cape_cin(pressure, temperature, dewpoint, moist_adiabat_lookup, moist_adiabats, vert_dim='model_level_number', depth=300, return_profile=False)`
:   Calculate CAPE and CIN for the most unstable parcel within a given 
    depth above the surface..
    
    Arguments:
        - pressure: Pressure level(s) of interest [hPa].
        - temperature: Temperature at each pressure level [K].
        - moist_adiabat_lookup, moist_adiabats: Adiabat lookup tables generated by 
                                                moist_adiabat_tables().
        - dewpoint: Dewpoint at each level [K].
        - vert_dim: The vertical dimension.
        - depth: The depth above the surface (lowest-level pressure) in which to 
                 look for the most unstable parcel.
        - return_profile: Also return the lifted profile?
        
    Returns:
    
        - Dataset with convective available potential energy (cape) and 
          convective inhibition (cin), both in J kg-1.

    
`most_unstable_parcel(dat, depth=300, drop=False, vert_dim='model_level_number')`
:   Return the most unstable parcel with an atmospheric layer from with the 
    requested bottom and depth. No interpolation is performed.
    
    Arguments:
        - dat: DataArray, must contain pressure, temperature, and dewpoint.
        - bottom: Pressure level to start from [hPa].
        - depth: Depth above the bottom of the layer to mix [hPa].
        - drop: Drop unselected elements?
        - vert_dim: Vertical dimension name.
    
    Returns:
    
        - xarray DataArray with pressure and data variables for the layer.

    
`parcel_profile(pressure, parcel_pressure, parcel_temperature, parcel_dewpoint, moist_adiabat_lookup, moist_adiabats)`
:   Calculate temperatures of a lifted parcel.
    
    Arguments:
        - pressure: Pressure levels to calculate on [hPa].
        - parcel_pressure: Pressure of the parcel [hPa].
        - parcel_temperature: Temperature of the parcel [K].
        - parcel_dewpoint: Dewpoint of the parcel [K].
        - moist_adiabat_lookup, moist_adiabats: Adiabat lookup tables generated by moist_adiabat_tables().
    
    Returns:
    
        - Dataset with the temperature of the parcel lifted from parcel_pressure to 
          levels in pressures, plus the LCL pressure and temperature.

    
`parcel_profile_with_lcl(pressure, temperature, parcel_pressure, parcel_temperature, parcel_dewpoint, moist_adiabat_lookup, moist_adiabats, vert_dim='model_level_number')`
:   Calculate temperatures of a lifted parcel, including at the lcl.
    
    Arguments:
        - pressure: Pressure levels to calculate on [hPa].
        - temperature: Temperature at each pressure level [K].
        - parcel_pressure: Pressure of the parcel [hPa].
        - parcel_temperature: Temperature of the parcel [K].
        - parcel_dewpoint: Dewpoint of the parcel [K].
        - moist_adiabat_lookup, moist_adiabats: Adiabat lookup tables generated by 
                                              moist_adiabat_tables().
        - vert_dim: The name of the vertical dimension.
    
    Returns:
    
         - Dataset with the temperature of the parcel lifted from parcel_pressure to 
             levels in pressures, including the LCL, plus the LCL pressure and temperature, and
             environmental temperature including at the LCL.

    
`round_to(x, to, dp=2)`
:   Round x to the nearest 'to' and return rounded to 'dp' decimal points.

    
`shift_out_nans(x, dim, pt=0)`
:   Shift data along a dim to remove all leading nans in that dimension, element-wise.
    
    Arguments:
        - x: The data to work on.
        - dim: The dimension to shift.
        - pt: The point along the dimension to shift 'to'.

    
`surface_based_cape_cin(pressure, temperature, dewpoint, moist_adiabat_lookup, moist_adiabats, vert_dim='model_level_number', return_profile=False)`
:   Calculate surface-based CAPE and CIN.
    
    Arguments:
        - pressure: Pressure level(s) of interest [hPa].
        - temperature: Temperature at each pressure level [K].
        - dewpoint: Dewpoint at each level [K].
        - moist_adiabat_lookup, moist_adiabats: Adiabat lookup tables generated by 
                                                moist_adiabat_tables().
        - vert_dim: The vertical dimension.
        - return_profile: Also return the lifted profile?
        
    Returns:
    
        - Dataset with convective available potential energy (cape) and 
          convective inhibition (cin), both in J kg-1.

    
`trap_around_zeros(x, y, dim, log_x=True, start=0)`
:   Calculate dx * y for points just before and after zeros in y.
    
    Arguments:
        - x: arrays of x along dim.
        - y: arrays of y along dim.
        - dim: Dimension along which to calculate.
        - log_x: Log transform x?
        - start: Zero-based position along dim to look for zeros.
        
    Returns:
    
        - a Dataset containin the areas and x coordinates for each rectangular area 
          calculated before and after each zero; and an array of x coordinates that should be 
          replaced by the new areas if integrating along x and including these areas afterwards.

    
`trapz(dat, x, dim, mask=None)`
:   Perform trapezoidal rule integration along an axis, ala numpy.trapz.
    Estimates int y dx.
    
    Arguments:
        - dat: Data to process.
        - x: The variable that contains 'x' values along dimension 'dim'.
        - dim: The dimension along which to integrate 'y' values.
        - mask: A mask the size of dx/means (ie dim.size-1) for which 
                areas to include in the integration.
    
    Returns:
    
        - Integrated value along the axis.